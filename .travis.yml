language: minimal
services: docker

branches:
    only:
        - main
        - /^release-[0-9]+\..*$/

# addons:
#   sonarcloud:
#     organization: "open-cluster-management"
#     token:
#       secure: ""

env:
    global:
        - OS=linux
        - COMPONENT_TAG_EXTENSION="-${TRAVIS_COMMIT}"

before_install:
    - set -e

stages:
    - build
    - unit-test
    - test-e2e
    - release-ff
    - publish

jobs:
    include:
        - stage: build
          name: 'Build the test image, push it, check potential leaked credentials and check image security scan status'
          if: type != cron
          language: node_js
          node_js: '12'
          install: npm ci
          script:
              - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then export COMPONENT_TAG_EXTENSION="-PR${TRAVIS_PULL_REQUEST}-${TRAVIS_COMMIT}"; fi;
              - make
              # - |
              #     make
              #     make component/build
              #     make component/push
              #     make security/scans

        - stage: unit-test
          name: 'Run unit tests'
          if: type = pull_request
          script:
              # Set the image tag differently for PRs
              - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then export COMPONENT_TAG_EXTENSION="-PR${TRAVIS_PULL_REQUEST}-${TRAVIS_COMMIT}"; fi;
              # Bootstrap the build harness, pull test image, and run unit tests.
              - make
              # - |
              #     make
              #     make component/pull
              #     make component/test/unit
              #     sonar-scanner --debug
        - stage: test-e2e
          name: 'Deploy the image to a cluster and run e2e tests'
          if: type = pull_request
          script:
              #Check out a clusterpool, set up oc, deploy, run e2e tests, and return clusterpool cluster
              - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then export COMPONENT_TAG_EXTENSION="-PR${TRAVIS_PULL_REQUEST}-${TRAVIS_COMMIT}"; fi;
              - |
                  make 
                  make component/pull 
                  make component/test/e2e
        - stage: release-ff
          name: 'Push commits from master to branch defined in RELEASE_FF_BRANCH'
          if: type = push AND branch =~ /^master$/
          script:
              - |
                  make 
                  make release-ff
        - stage: publish
          name: 'Publish the image to quay with an official version/sha tag and publish entry to integration pipeline stage'
          if: type = push AND branch =~ /^release-[0-9]+\..*$/
          script:
              - |
                  make 
                  make pipeline-manifest/update PIPELINE_MANIFEST_COMPONENT_SHA256=${TRAVIS_COMMIT} PIPELINE_MANIFEST_COMPONENT_REPO=${TRAVIS_REPO_SLUG} PIPELINE_MANIFEST_BRANCH=${TRAVIS_BRANCH}
